<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat de Apoio</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary: #4f46e5;
      --bg: #f3f4f6;
      --text: #1f2937;
      --bot-bg: #e0e7ff;
      --user-bg: #d1fae5;
      --button-bg: #eef2ff;
      --button-border: #c7d2fe;
      --dark-bg: #2d3748;
      --dark-text: #f9fafb;
      --dark-input: #374151;
      --dark-bot-bg: #4b5563;
      --dark-user-bg: #065f46;
      --dark-button-bg: #4b5563;
      --dark-button-text: #e5e7eb;
      --dark-button-hover-bg: #2d3748;
      --dark-button-border: #ffffff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
    }

    #chat-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 24px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
      z-index: 9999;
      transition: background-color 0.3s ease;
    }

    #chat-toggle:hover {
      background-color: #4338ca;
    }

    .chatbox {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 380px;
      height: 540px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      display: none;
      flex-direction: column;
      background: white;
      overflow: hidden;
      z-index: 9999;
      transition: background-color 0.3s ease;
    }

    .chatbox.active {
      display: flex;
    }

    .chatbox-header {
      background: var(--primary);
      color: white;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      position: relative;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .theme-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 18px;
    }

    .chatbox.dark-mode {
      background-color: var(--dark-bg);
    }

    @media (max-width: 500px) {
      .chatbox {
        width: 100vw;
        height: 100vh;
        border-radius: 0;
        bottom: 0;
        right: 0;
      }
    }

    .chatbox-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      scroll-behavior: smooth;
    }

    .chatbox.dark-mode .chatbox-messages {
      background: var(--dark-bg);
    }

    .message {
      display: flex;
      margin-bottom: 14px;
      max-width: 100%;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.3s ease forwards;
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .bot-message {
      flex-direction: row;
    }

    .user-message {
      flex-direction: row-reverse;
      align-self: flex-end;
    }

    .avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      margin: 0 10px;
      object-fit: cover;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .message-content {
      background: var(--bot-bg);
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 15px;
      color: var(--text);
      max-width: 250px;
      line-height: 1.4;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
      transition: background 0.3s ease, color 0.3s ease;
    }

    .user-message .message-content {
      background: var(--user-bg);
    }

    .chatbox.dark-mode .bot-message .message-content {
      background: var(--dark-bot-bg);
      color: var(--dark-text);
    }

    .chatbox.dark-mode .user-message .message-content {
      background: var(--dark-user-bg);
      color: var(--dark-text);
    }

    .chatbox-input {
      display: flex;
      border-top: 1px solid #e5e7eb;
      background: #fff;
      padding: 10px;
    }

    .chatbox.dark-mode .chatbox-input {
      background: var(--dark-input);
    }

    .chatbox-input input {
      flex: 1;
      padding: 14px;
      border: none;
      font-size: 14px;
      outline: none;
      background: transparent;
      color: inherit;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .chatbox.dark-mode .chatbox-input input {
      color: white;
    }

    .chatbox-input button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0 20px;
      cursor: pointer;
      border-radius: 12px;
      margin-left: 10px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .chatbox-input button i {
      font-size: 16px;
    }

    .chatbox-input button:hover {
      background: #4338ca;
    }

    .quick-replies {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 12px 16px;
      background: white;
      border-top: 1px solid #e5e7eb;
    }

    .chatbox.dark-mode .quick-replies {
      background: var(--dark-button-bg);
    }

    .quick-replies button {
      background-color: var(--button-bg);
      border: 1px solid var(--button-border);
      color: #1e3a8a;
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chatbox.dark-mode .quick-replies button {
      background: var(--dark-button-bg);
      color: var(--dark-button-text);
      border: 2px solid var(--dark-button-border);
    }

    .quick-replies button:hover {
      background-color: #e0e7ff;
    }

    .chatbox.dark-mode .quick-replies button:hover {
      background-color: var(--dark-button-hover-bg);
    }

    .privacy-message {
      text-align: center;
      font-size: 11px;
      padding: 6px;
      color: #6b7280;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 12px 16px;
      background: var(--bot-bg);
      border-radius: 18px;
      max-width: 70px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #9ca3af;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) {
      animation-delay: 0s;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {

      0%,
      60%,
      100% {
        transform: translateY(0);
        opacity: 0.4;
      }

      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }

    .chatbox.dark-mode .typing-indicator {
      background: var(--dark-bot-bg);
    }
  </style>
</head>

<body>

  <button id="chat-toggle"><i class="fas fa-comment-dots"></i> Precisa de ajuda?</button>

  <div class="chatbox" id="chatbox">
    <div class="chatbox-header">
      ü§ñ Apoio Virtual
      <button class="theme-toggle" onclick="toggleDarkMode(event)">üåô</button>
    </div>
    <div class="chatbox-messages" id="chat"></div>

    <div class="quick-replies" id="quickReplies">
      <button onclick="quickReply('Estou viciado em apostas.')">üéØ <span>Estou viciado em apostas.</span></button>
      <button onclick="quickReply('Algu√©m pr√≥ximo a mim est√° com problemas de v√≠cios.')">üë• <span>Algu√©m pr√≥ximo a mim
          est√° com problemas de v√≠cios.</span></button>
      <button onclick="transferToHuman()">üßë‚Äç‚öïÔ∏è <span>Falar com um profissional</span></button>
    </div>

    <div class="chatbox-input">
      <input type="text" id="userInput" placeholder="Digite aqui..." />
      <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>
    <div class="privacy-message">Este chat √© 100% an√¥nimo. Nenhuma conversa √© armazenada.</div>
  </div>

  <script>
    const chatbox = document.getElementById("chatbox");
    const toggleBtn = document.getElementById("chat-toggle");
    const chat = document.getElementById("chat");
    let atendimentoHumano = false; // controle local

    // gera ou recupera id √∫nico da sess√£o
    function getSessionId() {
      let id = sessionStorage.getItem("session_id");
      if (!id) {
        id = Date.now().toString() + Math.random().toString(36).substr(2, 5);
        sessionStorage.setItem("session_id", id);
      }
      return id;
    }



    // abrir/fechar chat
    toggleBtn.addEventListener("click", () => {
      chatbox.classList.toggle("active");
      toggleBtn.innerHTML = chatbox.classList.contains("active")
        ? '<i class="fas fa-times"></i> Fechar chat'
        : '<i class="fas fa-comment-dots"></i> Precisa de ajuda?';
    });

    function scrollToBottom() {
      setTimeout(() => { chat.scrollTop = chat.scrollHeight; }, 50);
    }

    function typeEffect(element, text, delay = 30) {
      let i = 0;
      const interval = setInterval(() => {
        if (i < text.length) {
          element.textContent += text.charAt(i);
          i++;
          scrollToBottom();
        } else {
          clearInterval(interval);
        }
      }, delay);
    }

    function showTypingIndicator() {
      const typingMsg = document.createElement("div");
      typingMsg.className = "message bot-message";
      typingMsg.id = "typing-indicator";
      const avatar = document.createElement("img");
      avatar.className = "avatar";
      avatar.src = "/static/caozinho.jpg";
      const typingIndicator = document.createElement("div");
      typingIndicator.className = "typing-indicator";
      for (let i = 0; i < 3; i++) {
        const dot = document.createElement("div");
        dot.className = "typing-dot";
        typingIndicator.appendChild(dot);
      }
      typingMsg.appendChild(avatar);
      typingMsg.appendChild(typingIndicator);
      chat.appendChild(typingMsg);
      scrollToBottom();
    }

    function hideTypingIndicator() {
      const typingIndicator = document.getElementById("typing-indicator");
      if (typingIndicator) typingIndicator.remove();
    }

    function addMessage(text, type = "bot") {
      const msg = document.createElement("div");
      msg.className = `message ${type}-message`;
      const avatar = document.createElement("img");
      avatar.className = "avatar";
      if (type === "user") {
        avatar.src = "/static/dog.png";
      } else if (type === "human") {
        avatar.src = "/static/images.png"; // Foto do profissional
      } else {
        avatar.src = "/static/caozinho.jpg"; // IA
      }

      const content = document.createElement("div");
      content.className = "message-content";
      msg.appendChild(avatar);
      msg.appendChild(content);
      chat.appendChild(msg);
      if (type === "bot") {
        typeEffect(content, text);
      } else {
        content.textContent = text;
      }
      scrollToBottom();
    }

    function quickReply(text) {
      document.getElementById("quickReplies").style.display = "none";
      document.getElementById("userInput").value = text;
      sendMessage();
    }


    let pollTimer = null;
    let mensagensRenderizadas = 0; // contador do que j√° foi consumido do backend

    async function transferToHuman() {
      document.getElementById("quickReplies").style.display = "none";
      atendimentoHumano = true;
      hideTypingIndicator(); // se estava mostrando "digitando..."

      try {
        // 1) Marca a sess√£o para humano no backend (ele tamb√©m adiciona a msg "Voc√™ ser√° atendido...")
        await fetch("/transfer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ session_id: getSessionId() })
        });

        // 2) Prime do polling: l√™ o hist√≥rico atual e AJUSTA o ponteiro
        const sessionId = getSessionId();
        const resp = await fetch(`/mensagens/${sessionId}`);
        const msgs = await resp.json();

        // ‚ùó N√£o re-renderize o passado: posicione o ponteiro no fim
        mensagensRenderizadas = msgs.length;

        // (Opcional) exibir s√≥ a √öLTIMA msg (a do "Voc√™ ser√° atendido...") sem repetir o resto:
        const last = msgs[msgs.length - 1];
        if (last) addMessage(last.text, last.sender);

        // 3) Inicia o polling (apenas mensagens novas a partir daqui)
        iniciarPollingHumano();

      } catch (error) {
        addMessage("N√£o foi poss√≠vel solicitar um profissional agora.", "bot");
        atendimentoHumano = false; // volta ao modo IA caso d√™ erro
      }
    }



    // --- Helpers de normaliza√ß√£o e fuzzy ----------------------------------------
    function normalizeBase(s) {
      return (s || "")
        .toLowerCase()
        .normalize("NFD").replace(/\p{Diacritic}/gu, "")         // remove acentos
        .replace(/[‚Äô'`¬¥]/g, "'")
        .replace(/[^\p{L}\p{N}\s'!?üíîüò≠üò¢üòû]/gu, " ")            // preserva letras, n√∫meros, espa√ßo e alguns emojis √∫teis
        .replace(/\s+/g, " ")
        .trim();
    }

    function leetToPlain(s) {
      // traduz leetspeak comum
      return s
        .replace(/0/g, "o")
        .replace(/1/g, "i")
        .replace(/3/g, "e")
        .replace(/4/g, "a")
        .replace(/5/g, "s")
        .replace(/7/g, "t");
    }

    function collapseRepeats(s) {
      // reduz repeti√ß√µes exageradas: "naooooo" -> "naoo" (mant√©m no m√°x 2)
      return s.replace(/(.)\1{2,}/g, "$1$1");
    }

    function normalizeAll(s) {
      return collapseRepeats(leetToPlain(normalizeBase(s)));
    }

    // Dist√¢ncia de Levenshtein simples (para typos)
    function editDistance(a, b) {
      const dp = Array(b.length + 1).fill(0).map((_, i) => i);
      for (let i = 1; i <= a.length; i++) {
        let prev = i - 1;
        dp[0] = i;
        for (let j = 1; j <= b.length; j++) {
          const tmp = dp[j];
          dp[j] = (a[i - 1] === b[j - 1])
            ? prev
            : 1 + Math.min(prev, dp[j], dp[j - 1]);
          prev = tmp;
        }
      }
      return dp[b.length];
    }

    // fuzzyIncludes: confere se "needle" aparece dentro de "hay" com toler√¢ncia a erros
    function fuzzyIncludes(hay, needle, maxEdits = 1) {
      hay = " " + hay + " ";
      if (hay.includes(needle)) return true;

      // janela deslizante com tamanho aproximado
      const n = needle.length;
      if (n === 0) return false;

      // limita custo para frases maiores
      const allowed = Math.min(maxEdits + Math.floor(n / 12), 2);

      for (let i = 0; i <= hay.length - n; i++) {
        const slice = hay.slice(i, i + n);
        if (editDistance(slice, needle) <= allowed) return true;
      }
      return false;
    }

    // Verifica m√∫ltiplas variantes de uma mesma frase/termo
    function fuzzyAny(hay, variants, maxEdits = 1) {
      return variants.some(v => {
        const n = normalizeAll(v);
        return n && fuzzyIncludes(hay, n, maxEdits);
      });
    }

    // --- Dicion√°rio de sinais cr√≠ticos ------------------------------------------
    const CRITICAL_PATTERNS = {
      // risco direto / idea√ß√£o
      suicidio: [
        "suicidio", "me matar", "tirar minha vida", "acabar com tudo",
        "quero morrer", "sem vontade de viver", "nao quero mais viver",
        "pensando em morrer", "ideacao suicida", "quero sumir"
      ],
      // sofrimento intenso / desespero
      distress: [
        "nao aguento", "nao aguento mais", "desespero", "sem saida", "sem sa√≠da",
        "to mal", "t√¥ mal", "muito mal", "pior dia", "crise de panico", "crise panico",
        "ataque de panico", "ansiedade forte", "desesperado", "no fundo do poco", "no fundo do po√ßo",
        "sou um lixo", "nao presto", "nao vejo futuro", "sofrendo demais"
      ],
      // pedido de ajuda / urg√™ncia
      help: [
        "quero ajuda", "preciso de ajuda", "socorro", "me ajuda", "ajuda por favor",
        "urgente", "falar com alguem", "conversar com alguem", "preciso falar com alguem",
        "posso falar com alguem", "quero conversar com alguem", "apoio agora"
      ],
      // contexto forte de jogo/colapso
      gambling_crisis: [
        "nao consigo parar de apostar", "nao consigo parar", "compulsao por apostar", "compulsao por jogo",
        "recaida", "reca√≠da", "voltei a apostar", "perdi tudo", "perdi meu salario", "perdi meu sal√°rio",
        "endividado", "muita divida", "muitas dividas", "divida com agiota", "cobranca pesada",
        "quebrado", "rompi limite"
      ],
      // familiares / rede de apoio
      family: [
        "meu marido aposta", "minha esposa aposta", "meu filho viciado", "minha filha viciada",
        "meu pai viciado", "minha mae viciada", "meu irm√£o viciado", "minha irm√£ viciada",
        "meu namorado aposta", "minha namorada aposta", "alguem proximo viciado", "algu√©m pr√≥ximo viciado",
        "ajuda para familia", "sou familiar de viciado", "sou parente de viciado"
      ],
      // emojis e sinais curtos de forte sofrimento (vale como disparador adicional)
      emojis: [
        "üò≠", "üíî", "üò¢", "üòû"
      ]
    };

    // Frases curtas ‚Äún√∫cleo‚Äù para pegar varia√ß√µes ainda mais livres (com fuzzy mais aberto)
    const CORE_SIGNALS = [
      "me matar", "acabar com tudo", "quero morrer", "nao aguento mais",
      "preciso de ajuda", "socorro", "sem saida", "muito mal",
      "nao consigo parar", "perdi tudo", "endividado"
    ];

    // --- Detector principal ------------------------------------------------------
    function detectCritical(text) {
      const raw = text || "";
      if (!raw.trim()) return { match: false };

      const norm = normalizeAll(raw);

      // 1) Emojis de sofrimento forte (detec√ß√£o direta)
      if (CRITICAL_PATTERNS.emojis.some(e => raw.includes(e))) {
        return { match: true, category: "emojis", trigger: "emoji" };
      }

      // 2) Padr√µes por categoria (fuzzy leve)
      for (const [category, variants] of Object.entries(CRITICAL_PATTERNS)) {
        if (category === "emojis") continue;
        if (fuzzyAny(norm, variants, 1)) {
          return { match: true, category, trigger: variants.find(v => fuzzyIncludes(norm, normalizeAll(v), 1)) || "fuzzy" };
        }
      }

      // 3) N√∫cleo com toler√¢ncia um pouco maior (para erros de digita√ß√£o pesados)
      if (fuzzyAny(norm, CORE_SIGNALS, 2)) {
        return { match: true, category: "core", trigger: "core-fuzzy" };
      }

      return { match: false };
    }

    // --- Fun√ß√£o compat√≠vel com seu c√≥digo atual ---------------------------------
    function containsCriticalKeyword(text) {
      return detectCritical(text).match === true;
    }


    async function sendMessage() {
      const input = document.getElementById("userInput");
      const message = input.value.trim();
      if (!message) return;

      input.value = "";

      // ‚ö†Ô∏è S√ì renderiza local quando N√ÉO estiver no modo humano
      if (!atendimentoHumano) {
        addMessage(message, "user");
      }

      // Modo humano: apenas envia para o backend (o polling renderiza depois)
      if (atendimentoHumano) {
        await fetch("/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, session_id: getSessionId() })
        });
        return;
      }

      // Palavras-chave -> oferta de humano (sem transfer autom√°tica aqui)
      if (containsCriticalKeyword(message)) {
        addMessage("Sinto muito por voc√™ estar passando por isso. Posso chamar um profissional para conversar com voc√™ agora mesmo. üíô", "bot");
        const quickArea = document.getElementById("quickReplies");
        quickArea.innerHTML = `<button onclick="transferToHuman()">üßë‚Äç‚öïÔ∏è Falar com um profissional</button>`;
        quickArea.style.display = "flex";
        return;
      }

      // IA normal
      showTypingIndicator();
      try {
        const response = await fetch("/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, session_id: getSessionId() })
        });
        const data = await response.json();
        hideTypingIndicator();

        if (!atendimentoHumano) {
          addMessage(data.reply, "bot");
        }
      } catch (error) {
        hideTypingIndicator();
        addMessage("Erro ao se comunicar com o servidor.", "bot");
      }
    }









    function iniciarPollingHumano() {
      if (pollTimer) clearInterval(pollTimer);

      pollTimer = setInterval(async () => {
        if (!atendimentoHumano) return;
        try {
          const sessionId = getSessionId();
          const resp = await fetch(`/mensagens/${sessionId}`);
          const mensagens = await resp.json();

          // Renderiza APENAS novas mensagens (a partir do ponteiro)
          if (mensagens.length > mensagensRenderizadas) {
            for (let i = mensagensRenderizadas; i < mensagens.length; i++) {
              const m = mensagens[i];
              addMessage(m.text, m.sender);
            }
            mensagensRenderizadas = mensagens.length;
          }
        } catch (err) {
          console.error("Erro ao buscar mensagens:", err);
        }
      }, 2000);
    }



    function toggleDarkMode(event) {
      event.stopPropagation();
      chatbox.classList.toggle("dark-mode");
      const isDark = chatbox.classList.contains("dark-mode");
      localStorage.setItem("chat-dark-mode", isDark);
      updateThemeIcon(isDark);
    }

    function loadTheme() {
      const isDark = localStorage.getItem("chat-dark-mode") === "true";
      if (isDark) chatbox.classList.add("dark-mode");
      updateThemeIcon(isDark);
    }

    function updateThemeIcon(isDark) {
      const iconBtn = document.querySelector(".theme-toggle");
      iconBtn.textContent = isDark ? "üåû" : "üåô";
    }

    window.addEventListener("load", async () => {
      loadTheme();

      // üí• Remove session_id salvo para come√ßar do zero
      sessionStorage.removeItem("session_id");

      const sessionId = getSessionId(); // novo ID gerado

      // Verifica status da nova sess√£o
      const res = await fetch(`/status_sessao/${sessionId}`);
      const data = await res.json();

      if (data.humano) {
        atendimentoHumano = true;
        iniciarPollingHumano();
        addMessage("Voc√™ ser√° atendido por um profissional em instantes.", "bot");
      } else {
        chat.innerHTML = "";
        mensagensRenderizadas = 0;
        addMessage("Precisa de ajuda ou quer conversar?", "bot");
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      const inputField = document.getElementById("userInput");
      inputField.addEventListener("input", () => {
        if (inputField.value.trim().length > 0) {
          document.getElementById("quickReplies").style.display = "none";
        }
      });

      document.getElementById("userInput").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault(); // impede quebra de linha
          sendMessage();      // chama a fun√ß√£o para enviar a mensagem
        }
      });
    });



  </script>

</body>

</html>